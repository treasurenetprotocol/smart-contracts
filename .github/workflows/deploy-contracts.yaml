name: Deploy Contracts

on:
  push:
    branches:
      - feature/**
  workflow_dispatch:
    inputs:
      action:
        description: Choose deploy or upgrade script family (matches package.json prefix)
        required: true
        default: deploy
        type: choice
        options:
          - deploy
          - upgrade
      target:
        description: Contract bundle/step (matches package.json middle segment)
        required: true
        default: base
        type: choice
        options:
          - base
          - tokenlocker
          - bid
          - wunit-wtcash
          - tcash
          - tcashauction
          - tcashloan
          - wtcash
          - producers
          - oracle
      network:
        description: Network to deploy to (must exist in package.json script)
        required: true
        default: dev
        type: choice
        options:
          - dev
          - dev2
          - testnet
          - mainnet
          - ethereum

concurrency:
  group: deploy-${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.network || 'manual' }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NODE_VERSION: 20

jobs:
  deploy:
    name: Compile and deploy ${{ github.event.inputs.target }} on ${{ github.event.inputs.network }}
    runs-on:
      - self-hosted
      - linux
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Remove lockfile (avoid mac-only deps like fsevents)
        run: rm -f package-lock.json

      - name: Install dependencies (fresh lock)
        env:
          NPM_CONFIG_OPTIONAL: "false"
        run: npm install --no-audit --no-fund --omit=optional

      - name: Compile contracts
        run: npm run compile

      - name: Resolve npm script
        id: script
        shell: bash
        run: |
          ACTION="${{ github.event.inputs.action }}"
          TARGET="${{ github.event.inputs.target }}"
          NETWORK="${{ github.event.inputs.network }}"

          SCRIPT="${ACTION}:${TARGET}:${NETWORK}"

          SCRIPT_ENV="$SCRIPT" node - <<'NODE'
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const script = process.env.SCRIPT_ENV;
          if (!pkg.scripts[script]) {
            console.error(`Script "${script}" not found in package.json. Add it before rerunning.`);
            process.exit(1);
          }
          NODE

          echo "script_name=$SCRIPT" >> "$GITHUB_OUTPUT"

      - name: Prepare network env
        id: envs
        shell: bash
        run: |
          NETWORK="${{ github.event.inputs.network }}"
          case "$NETWORK" in
            dev) RPC="${{ vars.RPC_DEV }}"; KEY="${{ secrets.DEPLOYER_PRIVATE_KEY_DEV }}" ;;
            dev2) RPC="${{ vars.RPC_DEV2 }}"; KEY="${{ secrets.DEPLOYER_PRIVATE_KEY_DEV2 }}" ;;
            testnet) RPC="${{ vars.RPC_TESTNET }}"; KEY="${{ secrets.DEPLOYER_PRIVATE_KEY_TESTNET }}" ;;
            mainnet) RPC="${{ vars.RPC_MAINNET }}"; KEY="${{ secrets.DEPLOYER_PRIVATE_KEY_MAINNET }}" ;;
            ethereum) RPC="${{ vars.RPC_ETHEREUM }}"; KEY="${{ secrets.DEPLOYER_PRIVATE_KEY_ETHEREUM }}" ;;
            *) echo "Unsupported network: $NETWORK" >&2; exit 1 ;;
          esac

          # Fallback to general secret if network-specific one is missing
          if [ -z "$KEY" ]; then
            KEY="${{ secrets.DEPLOYER_PRIVATE_KEY }}"
          fi

          if [ -z "$RPC" ]; then
            echo "RPC value for $NETWORK is not set. Define repo/org variable RPC_${NETWORK^^}." >&2
            exit 1
          fi

          if [ -z "$KEY" ]; then
            echo "Secret DEPLOYER_PRIVATE_KEY_${NETWORK^^} (or DEPLOYER_PRIVATE_KEY) is not configured." >&2
            exit 1
          fi

          echo "RPC=$RPC" >> "$GITHUB_ENV"
          echo "NETWORK=$NETWORK" >> "$GITHUB_ENV"
          printf 'PRIVATE_KEY=%s\n' "$KEY" >> "$GITHUB_ENV"

      - name: Run deployment script
        env:
          RPC: ${{ env.RPC }}
          PRIVATE_KEY: ${{ env.PRIVATE_KEY }}
        run: npm run ${{ steps.script.outputs.script_name }}
