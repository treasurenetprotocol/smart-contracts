# EthData Contract Documentation

The `EthData` contract is part of the production data system for Ethereum-based digital assets. It extends the functionality of the `ProductionData` contract to receive, verify, and process trusted production data from an oracle. This contract is used in the context of EthMinting and ensures that production data (e.g., block numbers, rewards, prices, amounts, and miner information) is authenticated before being used for reward distribution and clearing processes.

> **Note:** Many functions (such as setting and getting production data, registering asset value requests, etc.) are inherited from the `ProductionData` contract. Please refer to the `ProductionData` documentation for full details on those inherited functions.

## Table of Contents

- [Overview](#overview)
- [Functions](#functions)
  - [initialize](#initialize)
  - [receiveTrustedProductionData](#receivetrustedproductiondata)
  - [Internal Functions](#internal-functions)
- [Events](#events)
- [Structs and Enums](#structs-and-enums)
- [Inherited Functions](#inherited-functions)

## Overview

The `EthData` contract processes trusted production data received from an oracle. It performs several critical tasks:
- Validates the production data (e.g., ensuring non-zero block numbers and rewards).
- Verifies that the miner information matches the registered producer details.
- Stores the trusted production data keyed by block number and unique identifier.
- Triggers reward distribution and clearing of production data through internal mechanisms.

## Functions

### initialize(string memory _treasureKind, address _oracleContract, address _rolesContract, address _parameterInfoContract, address _producerContract, address _tatContract)

Initializes the EthData contract with the required parameters.

- **Parameters:**
  - `_treasureKind`: The type of treasure this contract handles.
  - `_oracleContract`: Address of the Oracle contract.
  - `_rolesContract`: Address of the Roles contract.
  - `_parameterInfoContract`: Address of the Parameter Info contract.
  - `_producerContract`: Address of the Producer contract.
  - `_tatContract`: Address of the TAT contract.

### receiveTrustedProductionData(bytes32 _requestId, bytes32 _uniqueId, ProduceData memory _produceData)

Receives trusted production data from the oracle.

- **Access:** External; can only be called by an account with the Feeder role and when the producer is active.
- **Parameters:**
  - `_requestId`: The request ID generated by the oracle for pulling production data.
  - `_uniqueId`: The unique identifier for the production data.
  - `_produceData`: The production data received from the oracle. This struct includes fields such as:
    - `blockNumber`
    - `blockReward`
    - `price`
    - `amount`
    - `miner`
- **Behavior:**
  - Verifies that the provided `_requestId` matches the stored request ID for `_uniqueId`.
  - Ensures that the `blockNumber` and `blockReward` are non-zero.
  - Retrieves the producer details and confirms that the miner (as provided in `_produceData`) matches the producer's registered account.
  - Stores the production data indexed by the block number and `_uniqueId`.
  - Emits the `TrustedDigitalProductionData` event.

## Internal Functions

These functions are internal to the contract and handle the processing and clearing of production data.

- **_clearing(bytes32 _uniqueId, uint256 blockNumber) -> bool**  
  Processes the clearing of production data by:
  - Verifying that the production data status is `UNAUDITED`.
  - Emitting a `VerifiedProduction` event.
  - Distributing rewards via the `_rewardByShare` function and ensuring the minted total equals the trusted amount.
  - Emitting a `ClearingReward` event.
  - Updating the production data status to `FINISHED`.

- **_afterClearing(bytes32 _uniqueId, uint256 blockNumber)**  
  A hook function executed after clearing (currently no additional logic is implemented).

- **_rewardByShare(bytes32 uniqueId, uint256 total) -> uint256**  
  Calculates and distributes rewards based on stakeholder shares by:
  - Calling the producer's `calculateRewards` function to obtain the distribution.
  - Invoking the `_reward` function to perform the reward distribution.
  - Returning the total reward distributed.

## Events

### TrustedDigitalProductionData(string treasureKind, bytes32 uniqueId, uint256 blockNumber, uint256 blockReward, uint256 price, uint256 amount, string miner)

Emitted when trusted digital production data is received from the oracle.

- **Parameters:**
  - `treasureKind`: The type of treasure.
  - `uniqueId`: The unique identifier for the production data.
  - `blockNumber`: The block number associated with the production data.
  - `blockReward`: The reward for the given block.
  - `price`: The price of the produced asset.
  - `amount`: The amount of the produced asset.
  - `miner`: The miner information (as a string).

> **Note:** Other events such as `VerifiedProduction` and `ClearingReward` are emitted during the clearing process. Refer to the `ProductionData` documentation for more details if needed.

## Structs and Enums

### ProduceData

A structure representing production data. (Defined in the parent `ProductionData` contract.)

- **Fields:**
  - `bytes32 uniqueId`: The unique identifier for the production data.
  - `uint256 counterId`: The counter id for production entries.
  - `address account`: The producerâ€™s account.
  - `uint256 amount`: The amount produced.
  - `uint256 price`: The price of the produced asset.
  - `uint256 date`: The production date.
  - `uint256 month`: The production month.
  - `string miner`: The miner information (applicable for EthMinting and BtcMinting).
  - `uint256 blockNumber`: The block number (for EthMinting and BtcMinting).
  - `uint256 blockReward`: The block reward (for EthMinting and BtcMinting).
  - `ProduceDataStatus status`: The status of the production data.

### ProduceDataStatus

An enum representing the state of production data.

- `UNAUDITED`: Production data has not yet been audited.
- `FINISHED`: Production data has been verified and cleared.
- `FAILED`: Production data verification failed.

## Inherited Functions

The `EthData` contract inherits additional functions from the `ProductionData` contract, including:

- **setProductionData(bytes32 _uniqueId, ProduceData memory _produceData) -> _uniqueId**  
  Sets the production data for a given unique identifier.  
  > *Warning:* The Producer must be in the Active state. Only the owner of the Producer can execute this.

- **getProductionData(bytes32 _uniqueId, uint256 month) -> ProduceData**  
  Retrieves the production data for a given unique identifier and month.

- **registerAssetValueRequest() -> bytes32**  
  Registers a request for asset value data.

- **receiveAssetValue(bytes32 _requestId, uint256 _date, uint256 _value) -> uint256**  
  Receives asset value data for a specific request.  
  > *Warning:* Only an account with the Feeder role can invoke this.

- **getAssetValue(uint256 _date) -> uint256**  
  Retrieves the asset value for a given date.

- **clearing(bytes32 _uniqueId, uint256 _month) -> _uniqueId**  
  Initiates the clearing process for the production data of a specific unique identifier and month.  
  > *Warning:* Only the Producer's owner can trigger this action.

For complete details on these inherited functions, please refer to the `ProductionData` documentation.
